<?php
/**
 * Created by PhpStorm.
 * User: Administrator
 * Date: 2018/8/12
 * Time: 22:31
 */


namespace app\index\controller;

use app\common\controller\Frontend;
use think\Lang;
use think\Db;
use QL\QueryList;

/**
 * Ajax异步请求接口
 * @internal
 */
class Caiji
{
    private $url = '';
    private $rule = array();
    private $bigCategory = '';
    private $smallCategory = array();
    private $parent_id = 0;


    public function _initialize()
    {
        parent::_initialize(); // TODO: Change the autogenerated stub
    }

    public function meet(){
        //采集某页面所有的图片
        $url = 'https://www.meishichina.com/YuanLiao/category/rql/';
        $data = [];
        //猪肉分类
        $data['zhurou'] = QueryList::get($url)->find('div.category_sub:nth-child(1) > ul > li > a')->attrs('title');
        //牛肉分类
        $data['niurou'] = QueryList::get($url)->find('div.category_sub:nth-child(2) > ul > li > a')->attrs('title');
        //鸡肉分类
        $data['jirou'] = QueryList::get($url)->find('div.category_sub:nth-child(3) > ul > li > a')->attrs('title');
        //羊肉分类
        $data['yangrou'] = QueryList::get($url)->find('div.category_sub:nth-child(4) > ul > li > a')->attrs('title');
        //蛋类
        $data['yangrou'] = QueryList::get($url)->find('div.category_sub:nth-child(5) > ul > li > a')->attrs('title');
        //其它肉类
        $data['other'] = QueryList::get($url)->find('div.category_sub:nth-child(6) > ul > li > a')->attrs('title');
        //其它禽类
        $data['other_qinlei'] = QueryList::get($url)->find('div.category_sub:nth-child(7) > ul > li > a')->attrs('title');

        $temp = [];
        $param = [];
        foreach($data as $key => $value){
            foreach($value as $k => $v){

                if ($k == 0){
                    $temp[$k]['parent_id'] = 0;
                    $temp[$k]['category_name'] = $v;
                    $temp[$k]['create_time'] = date('Y-m-d H:i:s');
                    $temp[$k]['update_time'] = date('Y-m-d H:i:s');
                    $res = db::name('shicai_category')->insert();
                    if ($res){
                        $this->parent_id = db::name('shicai_category')->getLastInsID();
                    }
                    unset($temp[$k]);
                }else{
                    $temp[$k]['parent_id'] = $this->parent_id;
                    $temp[$k]['category_name'] = $v;
                    $temp[$k]['create_time'] = date('Y-m-d H:i:s');
                    $temp[$k]['update_time'] = date('Y-m-d H:i:s');
                }
                $res = db::name('shicai_category')->insertAll($temp);
                if ($res){
                    echo $k.'-';
                }
            }
        }

        //打印结果
//        echo '<pre>';
//        print_r($data['niurou']->all());
    }

}