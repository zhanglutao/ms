<?php
/**
 * Created by PhpStorm.
 * User: Administrator
 * Date: 2018/8/12
 * Time: 22:31
 */


namespace app\index\controller;

use app\common\controller\Frontend;
use think\Lang;
use think\Db;
use QL\QueryList;

/**
 * Ajax异步请求接口
 * @internal
 */
class Caiji
{
    private $parent_id = 0;


    public function _initialize()
    {
        parent::_initialize(); // TODO: Change the autogenerated stub
    }

    public function meet(){
        //采集某页面所有的图片
        $url = 'https://www.meishichina.com/YuanLiao/category/rql/';
        $data = [];
        //猪肉分类
        $data['zhurou'] = QueryList::get($url)->find('div.category_sub:nth-child(1) > ul > li > a')->attrs('title');
        //牛肉分类
        $data['niurou'] = QueryList::get($url)->find('div.category_sub:nth-child(2) > ul > li > a')->attrs('title');
        //鸡肉分类
        $data['jirou'] = QueryList::get($url)->find('div.category_sub:nth-child(3) > ul > li > a')->attrs('title');
        //羊肉分类
        $data['yangrou'] = QueryList::get($url)->find('div.category_sub:nth-child(4) > ul > li > a')->attrs('title');
        //蛋类
        $data['yangrou'] = QueryList::get($url)->find('div.category_sub:nth-child(5) > ul > li > a')->attrs('title');
        //其它肉类
        $data['other'] = QueryList::get($url)->find('div.category_sub:nth-child(6) > ul > li > a')->attrs('title');
        //其它禽类
        $data['other_qinlei'] = QueryList::get($url)->find('div.category_sub:nth-child(7) > ul > li > a')->attrs('title');

        $temp = [];
        foreach($data as $key => $value){
            foreach($value as $k => $v){

                if ($k == 0){
                    $temp['parent_id'] = 0;
                    $temp['category_name'] = $v;
                    $temp['create_time'] = date('Y-m-d H:i:s');
                    $temp['update_time'] = date('Y-m-d H:i:s');
                    $res = db::name('shicai_category')->insert($temp);
                    if ($res){
                        $this->parent_id = db::name('shicai_category')->getLastInsID();
                    }
                }else{
                    $temp['parent_id'] = $this->parent_id;
                    $temp['category_name'] = $v;
                    $temp['create_time'] = date('Y-m-d H:i:s');
                    $temp['update_time'] = date('Y-m-d H:i:s');
                    $res = db::name('shicai_category')->insert($temp);
                    if ($res){
                        echo '采集分类成功';
                    }
                }

            }
        }
    }

    public function shuichanpin(){
        //采集某页面所有的图片
        $url = 'https://www.meishichina.com/YuanLiao/category/scl/';
        $data = [];
        //淡水鱼
        $data['danshuiyu'] = QueryList::get($url)->find('div.category_sub:nth-child(1) > ul > li > a')->attrs('title');
        //海水鱼
        $data['haishuiyu'] = QueryList::get($url)->find('div.category_sub:nth-child(2) > ul > li > a')->attrs('title');
        //虾类
        $data['xia'] = QueryList::get($url)->find('div.category_sub:nth-child(3) > ul > li > a')->attrs('title');
        //蟹类
        $data['xie'] = QueryList::get($url)->find('div.category_sub:nth-child(4) > ul > li > a')->attrs('title');
        //贝类
        $data['bei'] = QueryList::get($url)->find('div.category_sub:nth-child(5) > ul > li > a')->attrs('title');
        //其他水产类
        $data['other'] = QueryList::get($url)->find('div.category_sub:nth-child(6) > ul > li > a')->attrs('title');

        $temp = [];
        foreach($data as $key => $value){
            foreach($value as $k => $v){

                if ($k == 0){
                    $temp['parent_id'] = 0;
                    $temp['category_name'] = $v;
                    $temp['create_time'] = date('Y-m-d H:i:s');
                    $temp['update_time'] = date('Y-m-d H:i:s');
                    $res = db::name('shicai_category')->insert($temp);
                    if ($res){
                        $this->parent_id = db::name('shicai_category')->getLastInsID();
                    }
                }else{
                    $temp['parent_id'] = $this->parent_id;
                    $temp['category_name'] = $v;
                    $temp['create_time'] = date('Y-m-d H:i:s');
                    $temp['update_time'] = date('Y-m-d H:i:s');
                    $res = db::name('shicai_category')->insert($temp);
                    if ($res){
                        echo '采集分类成功';
                    }
                }

            }
        }
    }

    public function shucai(){
        //采集某页面所有的图片
        $url = 'https://www.meishichina.com/YuanLiao/category/shucailei/';
        $data = [];
        //茎叶类
        $data['jingye'] = QueryList::get($url)->find('div.category_sub:nth-child(1) > ul > li > a')->attrs('title');
        //瓜菜类
        $data['guacai'] = QueryList::get($url)->find('div.category_sub:nth-child(2) > ul > li > a')->attrs('title');
        //果实类
        $data['guoshi'] = QueryList::get($url)->find('div.category_sub:nth-child(3) > ul > li > a')->attrs('title');
        //根茎类
        $data['genjing'] = QueryList::get($url)->find('div.category_sub:nth-child(4) > ul > li > a')->attrs('title');
        //菌类
        $data['jun'] = QueryList::get($url)->find('div.category_sub:nth-child(5) > ul > li > a')->attrs('title');
        //其他
        $data['other'] = QueryList::get($url)->find('div.category_sub:nth-child(6) > ul > li > a')->attrs('title');

        $temp = [];
        foreach($data as $key => $value){
            foreach($value as $k => $v){

                if ($k == 0){
                    $temp['parent_id'] = 0;
                    $temp['category_name'] = $v;
                    $temp['create_time'] = date('Y-m-d H:i:s');
                    $temp['update_time'] = date('Y-m-d H:i:s');
                    $res = db::name('shicai_category')->insert($temp);
                    if ($res){
                        $this->parent_id = db::name('shicai_category')->getLastInsID();
                    }
                }else{
                    $temp['parent_id'] = $this->parent_id;
                    $temp['category_name'] = $v;
                    $temp['create_time'] = date('Y-m-d H:i:s');
                    $temp['update_time'] = date('Y-m-d H:i:s');
                    $res = db::name('shicai_category')->insert($temp);
                    if ($res){
                        echo '采集分类成功';
                    }
                }

            }
        }
    }

    public function guopin(){
        //采集某页面所有的图片
        $url = 'https://www.meishichina.com/YuanLiao/category/guopinlei/';
        $data = [];
        //鲜果类
        $data['xianguo'] = QueryList::get($url)->find('div.category_sub:nth-child(1) > ul > li > a')->attrs('title');
        //干果类
        $data['ganguo'] = QueryList::get($url)->find('div.category_sub:nth-child(2) > ul > li > a')->attrs('title');

        $temp = [];
        foreach($data as $key => $value){
            foreach($value as $k => $v){

                if ($k == 0){
                    $temp['parent_id'] = 0;
                    $temp['category_name'] = $v;
                    $temp['create_time'] = date('Y-m-d H:i:s');
                    $temp['update_time'] = date('Y-m-d H:i:s');
                    $res = db::name('shicai_category')->insert($temp);
                    if ($res){
                        $this->parent_id = db::name('shicai_category')->getLastInsID();
                    }
                }else{
                    $temp['parent_id'] = $this->parent_id;
                    $temp['category_name'] = $v;
                    $temp['create_time'] = date('Y-m-d H:i:s');
                    $temp['update_time'] = date('Y-m-d H:i:s');
                    $res = db::name('shicai_category')->insert($temp);
                    if ($res){
                        echo '.';
                    }
                }

            }
        }
    }

    public function mimian(){
        //采集某页面所有的图片
        $url = 'https://www.meishichina.com/YuanLiao/category/mmdr/';
        $data = [];
        //米类
        $data['mi'] = QueryList::get($url)->find('div.category_sub:nth-child(1) > ul > li > a')->attrs('title');
        //面类
        $data['mian'] = QueryList::get($url)->find('div.category_sub:nth-child(2) > ul > li > a')->attrs('title');
        //豆类
        $data['dou'] = QueryList::get($url)->find('div.category_sub:nth-child(3) > ul > li > a')->attrs('title');
        //豆制品
        $data['douzhipin'] = QueryList::get($url)->find('div.category_sub:nth-child(4) > ul > li > a')->attrs('title');
        //乳类
        $data['ru'] = QueryList::get($url)->find('div.category_sub:nth-child(5) > ul > li > a')->attrs('title');
        //方便食品类
        $data['fangbian'] = QueryList::get($url)->find('div.category_sub:nth-child(6) > ul > li > a')->attrs('title');

        $temp = [];
        foreach($data as $key => $value){
            foreach($value as $k => $v){

                if ($k == 0){
                    $temp['parent_id'] = 0;
                    $temp['category_name'] = $v;
                    $temp['create_time'] = date('Y-m-d H:i:s');
                    $temp['update_time'] = date('Y-m-d H:i:s');
                    $res = db::name('shicai_category')->insert($temp);
                    if ($res){
                        $this->parent_id = db::name('shicai_category')->getLastInsID();
                    }
                }else{
                    $temp['parent_id'] = $this->parent_id;
                    $temp['category_name'] = $v;
                    $temp['create_time'] = date('Y-m-d H:i:s');
                    $temp['update_time'] = date('Y-m-d H:i:s');
                    $res = db::name('shicai_category')->insert($temp);
                    if ($res){
                        echo '.';
                    }
                }

            }
        }
    }

    public function tiaoweipin(){
        $url = 'https://www.meishichina.com/YuanLiao/category/tiaoweipinl/';
        $data = [];
        //调味品
        $data['tiaoweipin'] = QueryList::get($url)->find('div.category_sub:nth-child(1) > ul > li > a')->attrs('title');
        //食用油
        $data['shiyongyou'] = QueryList::get($url)->find('div.category_sub:nth-child(2) > ul > li > a')->attrs('title');

        $temp = [];
        foreach($data as $key => $value){
            foreach($value as $k => $v){

                if ($k == 0){
                    $temp['parent_id'] = 0;
                    $temp['category_name'] = $v;
                    $temp['create_time'] = date('Y-m-d H:i:s');
                    $temp['update_time'] = date('Y-m-d H:i:s');
                    $res = db::name('shicai_category')->insert($temp);
                    if ($res){
                        $this->parent_id = db::name('shicai_category')->getLastInsID();
                    }
                }else{
                    $temp['parent_id'] = $this->parent_id;
                    $temp['category_name'] = $v;
                    $temp['create_time'] = date('Y-m-d H:i:s');
                    $temp['update_time'] = date('Y-m-d H:i:s');
                    $res = db::name('shicai_category')->insert($temp);
                    if ($res){
                        echo '.';
                    }
                }

            }
        }
    }

    public function yaoshi(){
        $url = 'https://www.meishichina.com/YuanLiao/category/yaoshiqita/';
        $data = [];
        //药食
        $data['tiaoweipin'] = QueryList::get($url)->find('div.category_sub:nth-child(1) > ul > li > a')->attrs('title');

        $temp = [];
        foreach($data as $key => $value){
            foreach($value as $k => $v){

                if ($k == 0){
                    $temp['parent_id'] = 0;
                    $temp['category_name'] = $v;
                    $temp['create_time'] = date('Y-m-d H:i:s');
                    $temp['update_time'] = date('Y-m-d H:i:s');
                    $res = db::name('shicai_category')->insert($temp);
                    if ($res){
                        $this->parent_id = db::name('shicai_category')->getLastInsID();
                    }
                }else{
                    $temp['parent_id'] = $this->parent_id;
                    $temp['category_name'] = $v;
                    $temp['create_time'] = date('Y-m-d H:i:s');
                    $temp['update_time'] = date('Y-m-d H:i:s');
                    $res = db::name('shicai_category')->insert($temp);
                    if ($res){
                        echo '.';
                    }
                }

            }
        }
    }

    public function food_category(){
        $url = 'https://home.meishichina.com/recipe-type.html';
        $data = [];
        //常见菜式
        $data['jiachangcai'] = QueryList::get($url)->find('div.category_sub:nth-child(1) > ul > li > a')->attrs('title');
        //主食/小吃
        $data['xiaochi'] = QueryList::get($url)->find('div.category_sub:nth-child(2) > ul > li > a')->attrs('title');
        //甜品/饮品
        $data['tianpin'] = QueryList::get($url)->find('div.category_sub:nth-child(3) > ul > li > a')->attrs('title');
        //适宜人群
        $data['tianpin'] = QueryList::get($url)->find('div.category_sub:nth-child(4) > ul > li > a')->attrs('title');
        //食疗食补
        $data['shibu'] = QueryList::get($url)->find('div.category_sub:nth-child(5) > ul > li > a')->attrs('title');
        //场景
        $data['changjing'] = QueryList::get($url)->find('div.category_sub:nth-child(6) > ul > li > a')->attrs('title');
        //饮食方式
        $data['yingshi'] = QueryList::get($url)->find('div.category_sub:nth-child(7) > ul > li > a')->attrs('title');
        //中式菜式
        $data['china'] = QueryList::get($url)->find('div.category_sub:nth-child(8) > ul > li > a')->attrs('title');
        //外国美食
        $data['world'] = QueryList::get($url)->find('div.category_sub:nth-child(9) > ul > li > a')->attrs('title');
        //烘焙
        $data['hongpei'] = QueryList::get($url)->find('div.category_sub:nth-child(10) > ul > li > a')->attrs('title');
        //传统美食
        $data['chuantong'] = QueryList::get($url)->find('div.category_sub:nth-child(11) > ul > li > a')->attrs('title');
        //节日食俗
        $data['jieri'] = QueryList::get($url)->find('div.category_sub:nth-child(12) > ul > li > a')->attrs('title');
        //按制作难度
        $data['hard'] = QueryList::get($url)->find('div.category_sub:nth-child(13) > ul > li > a')->attrs('html');
//        var_dump($data);exit;
        //按所需时间
        $data['time'] = QueryList::get($url)->find('div.category_sub:nth-child(14) > ul > li > a')->attrs('text');
        //按菜品口味
        $data['kouwei'] = QueryList::get($url)->find('div.category_sub:nth-child(15) > ul > li > a')->attrs('text');
        //按主要工艺
        $data['gongyi'] = QueryList::get($url)->find('div.category_sub:nth-child(16) > ul > li > a')->attrs('text');

        $url = file_get_contents('https://home.meishichina.com/recipe-type.html');

        $temp = [];
        foreach($data as $key => $value){
            foreach($value as $k => $v){

                if ($k == 0){
                    $temp['parent_id'] = 0;
                    $temp['food_category_name'] = $v;
                    $temp['create_time'] = date('Y-m-d H:i:s');
                    $temp['update_time'] = date('Y-m-d H:i:s');
                    $res = db::name('food_category')->insert($temp);
                    if ($res){
                        $this->parent_id = db::name('food_category')->getLastInsID();
                    }
                }else{
                    $temp['parent_id'] = $this->parent_id;
                    $temp['food_category_name'] = $v;
                    $temp['create_time'] = date('Y-m-d H:i:s');
                    $temp['update_time'] = date('Y-m-d H:i:s');
                    $res = db::name('food_category')->insert($temp);
                    if ($res){
                        echo '.';
                    }
                }

            }
        }
    }


    public function recai(){
        $url = file_get_contents('https://home.meishichina.com/recipe/recai/');

        $ql = QueryList::rules(array(
            'food_name' => array('#J_list >ul > li >.detail > h2>a','text'),
            'food_url' => array('#J_list >ul > li >.detail > h2>a','href'),
            'tags' => array('#J_list >ul > li >.detail > p.subcontent','text'),
            'images' => array('#J_list > ul > li > div.pic > a > img','data-src'),
            'author_name' => array('#J_list > ul > li > div.detail > p.subline > a','text'),
//            'author_url' => array('#J_list > ul > li > div.detail > p.subline > a','href'),
            'page' => array('.ui-page-inner .now_page','text'),
        ));
        $data = $ql->setHtml($url)->removeHead()->query()->getData();
        var_dump($data);
        Db::startTrans();
        foreach($data as $key => $value){
            if ($key == 0){
                unset($value['page']);
            }
            $value['create_time'] = $value['update_time'] = date('Y-m-d H:i:s');
            $value['images'] = explode('?',$value['images'])[0];
            $res = db::name('food_list')->insert($value);
//            echo db::name('food_list')->getLastSql();
            if (!$res){
                DB::rollback();
            }else{
                $html = file_get_contents($value['food_url']);
                $html = file_get_contents('https://home.meishichina.com/recipe-151200.html');
                $food1 = QueryList::rules(array(
                    'tips' => array('.recipeTip','text'),
                ));
                $data2 = $food1->setHtml($html)->removeHead()->query()->getData();
                $length = count($data2);
                $food1->destruct();
//                var_dump($data2);exit;
                $food = QueryList::rules(array(
                    'food_name' => array('#recipe_title','text'),
                    'descrption' => array('#block_txt1','text'),
                    'top_image' => array('#recipe_De_imgBox > a > img','src'),
                    'main_material' => array('div.recipeCategory_sub_R.clear','html'),
                    'other_tags' => array('body > div.wrap > div > div.space_left > div.space_box_home > div > fieldset > div > ul','html'),
                    'assist_material' => array('div.recipeCategory_sub_R.mt30.clear','html'),
                    'images' => array('.recipeStep_img > img','src'),
                ));


                $data = $food->setHtml($html)->removeHead()->query()->getData();
//                var_dump($data);exit;
                echo '<pre>';
//                print_r($data);exit;
//                $length = count($data2);

//                $data[0]['big_category'] = str_replace(' 家常菜谱   手机菜谱 您的位置：美食天下 > 菜谱 > ','',$data[0]['big_category']);

                if (!isset($data[0]['food_name'])){
                    $data1['food_name'] = '';
                }else{
                    $data1['food_name']= htmlspecialchars($data[0]['food_name']);
                }

                if (!isset($data[0]['description'])){
                    $data1['description'] = '';
                }else{
                    $data1['description'] = htmlspecialchars($data[0]['description']);
                }

                if (!isset($data[0]['top_image'])){
                    $data1['top_image'] = '';
                }else{
                    $data1['top_image'] = explode("?",$data[0]['top_image'])[0];
                }

                $count = count($data);
                for ($i = 0; $i < $count; $i++){
                    $data1['images'][$i] = explode('?',$data[$i]['images'])[0];
                }

                preg_match_all('/<b>(.+?)<\/b>/', $data[0]['main_material'], $tag1);
                preg_match_all('/<span class="category_s2">(.+?)<\/span>/', $data[0]['main_material'], $tag2);

                str_replace('<b>','',$tag1[1]);
                str_replace('</b>','',$tag1[1]);

                $main_material = array_combine($tag1[1],$tag2[1]);
//                var_dump($data[0]['tag2']);
                preg_match_all('/target="_blank">(.+?)<\/a>/', $data[0]['assist_material'], $tag3);
//                var_dump($tag3);
                preg_match_all('/<span class="category_s2">(.+?)<\/span>/', $data[0]['assist_material'], $tag4);

                str_replace('<b>','',$tag3[1]);
                str_replace('</b>','',$tag3[1]);

                $other_tags = array_combine($tag3[1],$tag4[1]);

                preg_match_all('/<b>(.+?)<\/b>/', $data[1]['other_tags'], $tag33);
//                var_dump($tag33);
                preg_match_all('/<span class="category_s2">(.+?)<\/span>/', $data[1]['other_tags'], $tag44);
//                var_dump($tag44);exit;

                str_replace('<b>','',$tag33[1]);
                str_replace('</b>','',$tag33[1]);

                $assist_material= array_combine($tag33[1],$tag44[1]);

                $data1['main_material'] = $main_material;
                $data1['other_tags'] = $other_tags;
                $data1['assist_material'] = $assist_material;
                if ($length > 3){
                    $data1['tips'] = $data2[$length-4]['tips'];
                }
                $data1['author'] = $data2[$length-3]['tips'];
                $data1['kitchen_ware'] = explode('：',$data2[$length-2]['tips'])[1];
                $data1['big_category'] = explode('|',str_replace('&nbsp;&nbsp;','|', htmlentities(trim(explode('：',$data2[$length-1]['tips'])[1]))));
                foreach ($data1['big_category'] as $k => $v){
                        $data1['big_category'][$k] = trim($v);
                }
                $count = count($data1['big_category']);
                unset($data1['big_category'][$count-1]);


                print_r($data1);exit;
                exit;
            }
        }
    }
}